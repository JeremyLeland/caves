<style>body { margin: 0; padding: 0; }</style>
<canvas id="canvas"></canvas>
    
<script type="module">
  import { TileMap, Tile } from '../src/TileMap.js';
  import { Node } from '../src/Pathfinding.js';
  import { Sprite, Direction } from '../src/Sprite.js';
  import { Actor } from '../src/Actor.js';
  import { LevelGen } from '../src/LevelGen.js';
  import { GameCanvas, Keyboard, Mouse } from '../src/GameCanvas.js';

  const gameCanvas = new GameCanvas(document.getElementById('canvas'));
  const keyboard = new Keyboard();
  const mouse = new Mouse();

  window.onmousewheel = (e) => gameCanvas.scrollBy(e.deltaX, e.deltaY);

  const COLS = 40, ROWS = 40;
  const tileMap = new TileMap({cols: COLS, rows: ROWS,
    tiles: await Tile.loadTiles({'rock_dark': true, 'path': true, 'empty': false}),
    indexMap: LevelGen.generateCaveArray(COLS + 1, ROWS + 1)
  });

  const actionFrames = {'cast': 7, 'thrust': 8, 'walk': 9, 'slash': 6, 'shoot': 13, 'hurt': 6};
  const actor = new Actor({centerX: 31, centerY: 60,
    sprites: await Sprite.loadSprites(
      ['shadow', 'body', 'chest', 'pants', 'hair', 'hat',  'belt', 'shoes'].map(e => `human/male/${e}`),
      actionFrames
    ),
    actionFrames: actionFrames
  });
  actor.action = 'walk';
  actor.direction = Direction.South;

  tileMap.spawn(actor);

  let hoverNode = null, path = null;

  const SCROLL_SPEED = 0.1;
  gameCanvas.update = (dt) => {
    if (keyboard.isPressed('ArrowLeft'))  gameCanvas.scrollBy(-SCROLL_SPEED * dt, 0);
    if (keyboard.isPressed('ArrowRight')) gameCanvas.scrollBy( SCROLL_SPEED * dt, 0);
    if (keyboard.isPressed('ArrowUp'))    gameCanvas.scrollBy(0, -SCROLL_SPEED * dt);
    if (keyboard.isPressed('ArrowDown'))  gameCanvas.scrollBy(0,  SCROLL_SPEED * dt);

    // Find closest node
    hoverNode = tileMap.nodeFor(mouse.x + gameCanvas.scrollX, mouse.y + gameCanvas.scrollY);

    if (hoverNode != null) {
      path = Node.A_Star(tileMap.nodeFor(actor.x, actor.y), hoverNode);
    }

    actor.update(dt);
  };
  gameCanvas.draw = (ctx) => {
    tileMap.draw(ctx);
    actor.draw(ctx);

    if (path != null) {
      ctx.fillStyle = 'green';

      path.forEach(node => {
        ctx.beginPath();
        ctx.arc(node.x, node.y, 10, 0, Math.PI * 2);
        ctx.fill();
      });
    }
  };
</script>
