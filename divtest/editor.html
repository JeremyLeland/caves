<link rel="stylesheet" href="styles.css">
<style>
#wrapper {
  display: flex;
  flex-flow: row;
  margin: 0;
  padding: 0;
  min-height: 100vh;
  max-height: 100vh;
}
#editor {
  position: relative;
  /* padding: 16px; */
  flex: 1;
  margin: 0;
  overflow: auto;
  display: table;
}
#main {
  display: table-cell;
}
#palette {
  width: 75px;
  max-height: 100vh;
  overflow: auto;
}
/* Rulers */
.horizontalRuler {
  /* position: sticky; */
  /* float: left; */
  /* top: 0; */
  /* z-index: 1000; */
  background: orange;
  /* margin-left: 16px; */
  /* width: 100%; */
  height: 16px;
  display: table-row;
}
.verticalRuler {
  /* position: sticky; */
  /* left: 0; */
  /* float: left; */
  /* z-index: 1000; */
  background: red;
  width: 16px;
  display: table-cell;
  /* height: 100%; */
}
.rulerButton {
  background: lightskyblue;
  position: absolute;
  /* float: left; */
  padding: 0;
  width: 16px;
  height: 16px;
  display: inline-block;
}
/* Center our ruler buttons */
#insertCol {
  background: lightcoral;
  top: 0;
}
#deleteCol {
  background: lightsalmon;
  top: 0;
  /* margin-left: -8px; */
}
#insertRow {
  background: lightseagreen;
  left: 0;
}
#deleteRow {
  background: lightskyblue;
  left: 0;
  /* margin-top: -8px; */
}
</style>
<body>
  <div id="wrapper">
    <div id="editor">
      <div id="topRuler" class="horizontalRuler">
        <button id="deleteCol" class="rulerButton horizontalButton">-</button>
        <button id="insertCol" class="rulerButton">+</button>
      </div>
      <div id="leftRuler" class="verticalRuler">
        <button id="deleteRow" class="rulerButton">-</button>
        <button id="insertRow" class="rulerButton">+</button>
      </div>
      <div id="main"></div>
      <div id="rightRuler" class="verticalRuler">
      </div>
      <div id="bottomRuler" class="horizontalRuler">
      </div>
    </div>
    <div id="palette">
      <input type="checkbox" id="showPath" checked>
      <label for="showPath">Path</label>
      <input type="checkbox" id="showGrid" checked>
      <label for="showGrid">Grid</label>
      <button id="save">Save</button>
      <button id="clear">Clear</button>
      <button id="play">Play</button>
      <div id="groundPalette">
        <label for="showGround">Ground</label>
      </div>
      <div id="propsPalette">
        <label for="showProps">Props</label>
      </div>
      <div id="actorsPalette">
        <label for="showActors">Actors</label>
      </div>
    </div>
  </div>
</body>

<script type="module">
  import { tileInfos, propInfos, TileMap, MapLayer, TileSize } from './tilemap.js';
  import { actorInfos } from './actor.js';

  const cols = 10, rows = 10;
  const defaultJson = {
    "ground": {
      "cols": cols, "rows": rows,
      "tileInfoKeys": [ "dirt" ],
      "tileMap": Array( cols * rows ).fill( 0 ),
    },
    "props": {},
    "actors": {}
  }

  const json = localStorage.tileMapJson ? JSON.parse( localStorage.tileMapJson ) : defaultJson;

  const tileMap = new TileMap( json );

  const mainDiv = document.getElementById( 'main' );
  mainDiv.appendChild( tileMap.levelDiv );

  document.getElementById( 'showPath' ).oninput = ( e ) => {
    tileMap.pathfindingSVG.style.display = e.target.checked ? 'initial' : 'none'
  };

  document.getElementById( 'save' ).onclick = ( e ) => {
    localStorage.tileMapJson = JSON.stringify( tileMap.toJson() );
    console.log( localStorage.tileMapJson );
  };

  const palettes = [];
  palettes[ MapLayer.Ground ] = document.getElementById( 'groundPalette' );
  palettes[ MapLayer.Props ]  = document.getElementById( 'propsPalette' );
  palettes[ MapLayer.Actors ] = document.getElementById( 'actorsPalette' );

  Object.keys( tileInfos ).forEach( tileInfoKey => {
    createButton( tileInfoKey, MapLayer.Ground );
  } );
  [ null, ...Object.keys( propInfos ) ].forEach( propInfoKey => {
    createButton( propInfoKey, MapLayer.Props );
  } );
  [ null, ...Object.keys( actorInfos ) ].forEach( actorInfoKey => {
    createButton( actorInfoKey, MapLayer.Actors );
  } );

  let activeBrush = 'dirt', activeLayer = MapLayer.Ground;
  function createButton( entity, layer ) {
    const button = document.createElement( 'button' );
    button.innerText = entity ?? 'None';

    button.onclick = () => {
      activeBrush = entity;
      activeLayer = layer;
    }

    palettes[ layer ].appendChild( button );
  }

  const deleteColButton = document.getElementById( 'deleteCol' );
  const insertColButton = document.getElementById( 'insertCol' );
  const deleteRowButton = document.getElementById( 'deleteRow' );
  const insertRowButton = document.getElementById( 'insertRow' );

  deleteColButton.onclick = () => { tileMap.deleteCol( 5 ); }
  insertColButton.onclick = () => { tileMap.insertCol( 5 ); }
  deleteRowButton.onclick = () => { tileMap.deleteRow( 5 ); }
  insertRowButton.onclick = () => { tileMap.insertRow( 5 ); }

  let mouseDown = false, lastCell = null;
  tileMap.levelDiv.onmousedown = ( e ) => { mouseDown = true; doMouse( e ); }
  tileMap.levelDiv.onmouseup   = ( e ) => { mouseDown = false; }
  tileMap.levelDiv.onmousemove = ( e ) => { doMouse( e ); }

  function doMouse( mouseEvent ) {
    const cell = mouseEvent.target.cell;

    insertColButton.style.left = cell.x;
    deleteColButton.style.left = cell.x + TileSize / 2;

    insertRowButton.style.top = cell.y;
    deleteRowButton.style.top = cell.y + TileSize / 2;

    if ( mouseDown && cell != lastCell ) {
      lastCell = cell;
      tileMap.changeCellKey( cell, activeBrush, activeLayer );
    }
  }

</script>