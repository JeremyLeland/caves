<link rel="stylesheet" href="styles.css">
<style>
#wrapper {
  display: flex;
  flex-flow: row;
  margin: 0;
  padding: 0;
  min-height: 100vh;
  max-height: 100vh;
}
#editor {
  position: relative;
  flex: 1;
  margin: 0;
  overflow: auto;
}
#palette {
  width: 75px;
  max-height: 100vh;
  overflow: auto;
}
</style>
<body>
  <div id="wrapper">
    <div id="editor">
    </div>
    <div id="palette">
      <input type="checkbox" id="showPath" checked>
      <label for="showPath">Path</label>
      <input type="checkbox" id="showGrid" checked>
      <label for="showGrid">Grid</label>
      <button id="save">Save</button>
      <button id="clear">Clear</button>
      <button id="play">Play</button>
      <div id="groundPalette">
        <input type="checkbox" id="showGround" checked>
        <label for="showGround">Ground</label>
      </div>
      <div id="propsPalette">
        <input type="checkbox" id="showProps" checked>
        <label for="showProps">Props</label>
      </div>
      <div id="actorsPalette">
        <input type="checkbox" id="showActors" checked>
        <label for="showActors">Actors</label>
      </div>
    </div>
  </div>
</body>

<script type="module">
  import { TileMap, MapLayer } from './tilemap.js';

  const cols = 10, rows = 10;
  const defaultJson = {
    "ground": {
      "cols": cols, "rows": rows,
      "tileInfoKeys": [ "dirt" ],
      "tileMap": Array( cols * rows ).fill( 0 ),
    },
    "props": {},
    "actors": {}
  }

  const json = localStorage.tileMapJson ? JSON.parse( localStorage.tileMapJson ) : defaultJson;

  const tileMap = new TileMap( json );

  const editorDiv = document.getElementById( 'editor' );
  editorDiv.appendChild( tileMap.tileMapDiv );

  document.getElementById( 'showPath' ).oninput = ( e ) => {
    tileMap.pathfindingSVG.style.display = e.target.checked ? 'initial' : 'none'
  };

  document.getElementById( 'save' ).onclick = ( e ) => {
    localStorage.tileMapJson = JSON.stringify( tileMap.toJson() );
    console.log( localStorage.tileMapJson );
  };

  let activeBrush = 'dirt', activeLayer = MapLayer.Ground;
  const groundPalette = document.getElementById( 'groundPalette' );
  TileMap.getTileInfoKeys().forEach( tileInfoKey => {
    createButton( tileInfoKey, MapLayer.Ground, groundPalette );
  } );
  const propsPalette = document.getElementById( 'propsPalette' );
  createButton( null, MapLayer.Props, propsPalette );
  TileMap.getPropInfoKeys().forEach( propInfoKey => {
    createButton( propInfoKey, MapLayer.Props, propsPalette );
  } );

  function createButton( entity, layer, ui ) {
    const button = document.createElement( 'button' );
    button.innerText = entity ?? 'None';

    button.onclick = () => {
      activeBrush = entity;
      activeLayer = layer;
    }
    ui.appendChild( button );
    ui.appendChild( document.createElement( 'br' ) );
  }

  let mouseDown = false, mouseX = 0, mouseY = 0;
  tileMap.tileMapDiv.onmousedown = ( e ) => { mouseDown = true; doMouse( e ); }
  tileMap.tileMapDiv.onmousemove = ( e ) => { doMouse( e ); }
  tileMap.tileMapDiv.onmouseup   = ( e ) => { mouseDown = false; }

  function doMouse( mouseEvent ) {
    if ( mouseDown ) {
      // NOTE: Props were picking up mouse events
      // Consider pointer-events: none for these
      // In the meantime, work around it by using layerX/Y,
      // which seems to be relative to the tileMap
      tileMap.setKeyAt( { 
        x: mouseEvent.layerX,
        y: mouseEvent.layerY, 
        key: activeBrush,
        layer: activeLayer
      } );
    }
  }

</script>