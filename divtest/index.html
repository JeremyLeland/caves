<style>
  body {
    margin: 0;
    background-color: dimgray;
    overscroll-behavior: none; /* Disable Chrome two fingers back/forward swipe */
  }
  .tile { position: absolute; width: 32; height: 32; }

  .prop { position: absolute; }
  .tree { background-image: url( ../images/trees.png ); }
  .tree1 { width: 96; height: 128; background-position: -128 -96; }

  .actor { position: absolute; }
  .layer {
    width: inherit; height: inherit; 
    background-position: inherit;
    position: absolute;
  }
</style>
<div class="prop tree tree1" style="left: 32; top: 32; z-index: 160;"></div>
<div class="prop tree tree1" style="left: 64; top: 96; z-index: 224;"></div>

<script type="module">
  import * as TileMap from './tilemap.js';
  import * as Actor from './actor.js';

  const tileInfos   = await ( await fetch( './tileInfos.json'   ) ).json();
  const spriteInfos = await ( await fetch( './spriteInfos.json' ) ).json();
  const actorInfos  = await ( await fetch( './actorInfos.json'  ) ).json();

  const level = {
    "ground": {
      "cols": 10, "rows": 10,
      "tileInfoKeys": [ "dirt", "grass", "snow" ],
      "tileMap": [
        0, 0, 0, 0, 0, 1, 1, 1, 1, 1,
        0, 1, 1, 1, 0, 1, 0, 0, 0, 1,
        0, 1, 0, 1, 0, 1, 2, 2, 0, 1,
        0, 1, 1, 1, 0, 1, 0, 0, 0, 1,
        0, 0, 0, 0, 0, 1, 1, 1, 1, 1,
        0, 1, 0, 1, 0, 0, 0, 0, 0, 0,
        0, 0, 1, 0, 0, 0, 1, 0, 0, 0,
        0, 1, 0, 1, 0, 1, 1, 1, 0, 0,
        0, 0, 0, 0, 0, 0, 1, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
      ]
    },
    "actors": [
      { "actorInfoKey": "goblin",   "x": 32, "y": 160 },
      { "actorInfoKey": "spider",   "x": 48, "y": 224 },
      { "actorInfoKey": "hero",     "x": 64, "y": 320 },
      { "actorInfoKey": "skeleton", "x": 96, "y": 250 },
    ]
  }

  TileMap.prepareCSS( { tileInfos: tileInfos } );

  TileMap.getTileMapDivs( {
    cols: level.ground.cols, rows: level.ground.rows,
    tileInfoKeys: level.ground.tileInfoKeys,
    tileMap: level.ground.tileMap
  } );

  Actor.prepareCSS( { spriteInfos: spriteInfos, actorInfos: actorInfos } );

  const actors = level.actors.map( actorJson => 
    Actor.fromJson( { 
      json: actorJson, actorInfos: actorInfos, spriteInfos: spriteInfos
    } )
  );

  let mouseX = 0, mouseY = 0;
  document.onmousemove = ( e ) => {
    mouseX = e.pageX;
    mouseY = e.pageY;
  };

  let lastTime = null;
  function animate( now ) {
    lastTime ??= now;   // for first call only
    update( now - lastTime );
    lastTime = now;

    requestAnimationFrame( animate );
  }
  requestAnimationFrame( animate );

  function update( dt ) {
    actors.forEach( actor => {
      actor.angle = Math.atan2( mouseY - actor.y, mouseX - actor.x );

      Actor.update( {
        actor: actor,
        others: actors.filter( other => other != actor ),
        dt: dt
      } );
    } );
  }

  setInterval( () => {
    actors.forEach( actor => {
      const action = actor.spriteInfo.actions[ actor.action ];
      actor.frame = ( actor.frame + 1 ) % action.frames;
    });
  }, 100 );


</script>