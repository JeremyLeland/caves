<style>
  body {
    margin: 0;
    background-color: dimgray;
    overscroll-behavior: none; /* Disable Chrome two fingers back/forward swipe */
  }
  .tile { position: absolute; width: 32; height: 32; }

  .prop { position: absolute; }
  .tree { background-image: url( ../images/trees.png ); }
  .tree1 { width: 96; height: 128; background-position: -128 -96; }

  .actor { position: absolute; }
  .layer {
    width: inherit; height: inherit; 
    background-position: inherit;
    position: absolute;
  }
</style>
<div class="prop tree tree1" style="left: 32; top: 32; z-index: 160;"></div>
<div class="prop tree tree1" style="left: 64; top: 96; z-index: 224;"></div>

<script type="module">
  import * as TileMap from './tilemap.js';
  import * as Actor from './actor.js';

  const tileInfos = {
    "imagesPath": "../images/terrain/",
    "tiles": {
      "dirt": { "passable": true },
      "sand": { "passable": true },
      "rock_dark": { "passable": true },
      "rock_light": { "passable": true },
      "path": { "passable": true },
      "water": { "passable": false },
      "hole": { "passable": false },
      "empty": { "passable": false },
      "grass": { "passable": true },
      "snow": { "passable": true }
    }
  }

  const spriteInfos = { 
    "humanoid": {
      "width": 64, "height": 64,
      "center": { x: 31, y: 60 },
      "dirIndex": { "north": 0, "west": 1, "south": 2, "east": 3 },
      "actions": {
        "idle":   { "col": 0, "row":  0, "frames":  1 },
        "walk":   { "col": 1, "row":  8, "frames":  8, "loop": true },
        "cast":   { "col": 1, "row":  0, "frames":  6 },
        "thrust": { "col": 1, "row":  4, "frames":  7 },
        "slash":  { "col": 1, "row": 12, "frames":  5 },
        "shoot":  { "col": 1, "row": 16, "frames": 12 },
        "die":    { "col": 1, "row": 20, "frames":  5 }
      }
    },
    "goblin": {
      "width": 65, "height": 65,
      "centers": {
        "south": { x: 32, y: 50 },
        "east":  { x: 22, y: 54 },
        "north": { x: 32, y: 58 },
        "west":  { x: 42, y: 54 }
      },
      "dirIndex": { "north": 2, "west": 3, "south": 0, "east": 1 },
      "actions": {
        "idle":   { "col":  6, "row":  0, "frames": 1 },
        "walk":   { "col":  0, "row":  0, "frames": 7, "loop": true },
        "thrust": { "col":  7, "row":  0, "frames": 4 },
        "slash":  { "col": 11, "row":  0, "frames": 6 },
        "die":    { "col":  0, "row":  4, "frames": 5 }
      }
    },
    "spider": {
      "width": 64, "height": 64,
      "center": { x: 31, y: 45 },
      "dirIndex": { "north": 0, "west": 1, "south": 2, "east": 3 },
      "actions": {
        "idle":   { "col": 0, "row": 0, "frames": 1 },
        "walk":   { "col": 4, "row": 0, "frames": 6, "loop": true },
        "attack": { "col": 1, "row": 0, "frames": 4 },
        "die":    { "col": 0, "row": 4, "frames": 4 }
      }
    }
  };

  const actorInfos = {
    "hero": {
      "imagesPath": "../images/sprites/humanoid/male",
      "layers": [
        "shadow", "body", "chest", "pants", "hair", "hat", "belt", "shoes", "dagger"
      ],
      "spriteInfoKey": "humanoid",
      "life": 100,
      "speed": 0.1
    },
    "skeleton": {
      "imagesPath": "../images/sprites/humanoid/male",
      "layers": [ "shadow", "skeleton", "axe" ],
      "spriteInfoKey": "humanoid",
      "life": 25,
      "speed": 0.1
    },
    "goblin": {
      "imagesPath": "../images/sprites/goblin",
      "layers": [ "base", "sword" ],
      "spriteInfoKey": "goblin",
      "life": 20,
      "speed": 0.1
    },
    "spider": {
      "imagesPath": "../images/sprites/spider",
      "layers": [ "base" ],
      "spriteInfoKey": "spider",
      "life": 10,
      "speed": 0.1
    }
  }

  const level = {
    "ground": {
      "cols": 10, "rows": 10,
      "tileInfoKeys": [ "dirt", "grass", "snow" ],
      "tileMap": [
        0, 0, 0, 0, 0, 1, 1, 1, 1, 1,
        0, 1, 1, 1, 0, 1, 0, 0, 0, 1,
        0, 1, 0, 1, 0, 1, 2, 2, 0, 1,
        0, 1, 1, 1, 0, 1, 0, 0, 0, 1,
        0, 0, 0, 0, 0, 1, 1, 1, 1, 1,
        0, 1, 0, 1, 0, 0, 0, 0, 0, 0,
        0, 0, 1, 0, 0, 0, 1, 0, 0, 0,
        0, 1, 0, 1, 0, 1, 1, 1, 0, 0,
        0, 0, 0, 0, 0, 0, 1, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
      ]
    },
    "actors": [
      { "actorInfoKey": "goblin",   "x": 32, "y": 160 },
      { "actorInfoKey": "spider",   "x": 48, "y": 224 },
      { "actorInfoKey": "hero",     "x": 64, "y": 320 },
      { "actorInfoKey": "skeleton", "x": 96, "y": 250 },
    ]
  }

  TileMap.prepareCSS( { tileInfos: tileInfos } );

  TileMap.getTileMapDivs( {
    cols: level.ground.cols, rows: level.ground.rows,
    tileInfoKeys: level.ground.tileInfoKeys,
    tileMap: level.ground.tileMap
  } );

  Actor.prepareCSS( { spriteInfos: spriteInfos, actorInfos: actorInfos } );

  const actors = level.actors.map( actorJson => 
    Actor.fromJson( { 
      json: actorJson, actorInfos: actorInfos, spriteInfos: spriteInfos
    } )
  );

  let mouseX = 0, mouseY = 0;
  document.onmousemove = ( e ) => {
    mouseX = e.pageX;
    mouseY = e.pageY;
  };

  let lastTime = null;
  function animate( now ) {
    lastTime ??= now;   // for first call only
    update( now - lastTime );
    lastTime = now;

    requestAnimationFrame( animate );
  }
  requestAnimationFrame( animate );

  function update( dt ) {
    actors.forEach( actor => {
      actor.angle = Math.atan2( mouseY - actor.y, mouseX - actor.x );

      Actor.update( {
        actor: actor,
        others: actors.filter( other => other != actor ),
        dt: dt
      } );
    } );
  }

  setInterval( () => {
    actors.forEach( actor => {
      const action = actor.spriteInfo.actions[ actor.action ];
      actor.frame = ( actor.frame + 1 ) % action.frames;
    });
  }, 100 );


</script>