<style>
  body {
    margin: 0;
    background-color: dimgray;
    overscroll-behavior: none; /* Disable Chrome two fingers back/forward swipe */
  }
  .tile { position: absolute; width: 32; height: 32; }

  .prop { position: absolute; }

  .actor { position: absolute; }
  .layer {
    width: inherit; height: inherit; 
    background-position: inherit;
    position: absolute;
  }
</style>
<body>
  <!-- TODO: Group entities like this? Might also let us format them easier -->
  <!-- <div id="tileMap"></div>
  <div id="props"></div>
  <div id="actors"></div> -->
</body>

<script type="module">
  import * as TileMap from './tilemap.js';
  import * as Prop    from './prop.js';
  import * as Actor   from './actor.js';

  const level = {
    "ground": {
      "cols": 10, "rows": 10,
      "tileInfoKeys": [ "dirt", "grass", "snow" ],
      "tileMap": [
        0, 0, 0, 0, 0, 1, 1, 1, 1, 1,
        0, 1, 1, 1, 0, 1, 0, 0, 0, 1,
        0, 1, 0, 1, 0, 1, 2, 2, 0, 1,
        0, 1, 1, 1, 0, 1, 0, 0, 0, 1,
        0, 0, 0, 0, 0, 1, 1, 1, 1, 1,
        0, 1, 0, 1, 0, 0, 0, 0, 0, 0,
        0, 0, 1, 0, 0, 0, 1, 0, 0, 0,
        0, 1, 0, 1, 0, 1, 1, 1, 0, 0,
        0, 0, 0, 0, 0, 0, 1, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
      ]
    },
    "props": [
      { "propInfoKey": "tree1", "col": 1, "row": 1 },
      { "propInfoKey": "tree1", "col": 2, "row": 3 },
    ],
    "actors": [
      { "actorInfoKey": "goblin",   "col": 1, "row": 5 },
      { "actorInfoKey": "spider",   "col": 2, "row": 6 },
      { "actorInfoKey": "hero",     "col": 3, "row": 7 },
      { "actorInfoKey": "skeleton", "col": 4, "row": 8 },
    ]
  }

  // TODO: Make these init(), and have them prepare the DOM as well as CSS
  TileMap.prepareCSS();
  Prop.prepareCSS();
  Actor.prepareCSS();

  // TODO: Make this "fromJson" like with actor (taking level.ground as json)
  TileMap.getTileMapDivs( {
    cols: level.ground.cols, rows: level.ground.rows,
    tileInfoKeys: level.ground.tileInfoKeys,
    tileMap: level.ground.tileMap
  } );

  level.props.forEach( json => Prop.fromJson( json ) );

  const actors = level.actors.map( json => Actor.fromJson( json ) );

  let mouseX = 0, mouseY = 0;
  document.onmousemove = ( e ) => {
    mouseX = e.pageX;
    mouseY = e.pageY;
  };

  let lastTime = null;
  function animate( now ) {
    lastTime ??= now;   // for first call only
    update( now - lastTime );
    lastTime = now;

    requestAnimationFrame( animate );
  }
  requestAnimationFrame( animate );

  function update( dt ) {
    actors.forEach( actor => {
      actor.angle = Math.atan2( mouseY - actor.y, mouseX - actor.x );

      Actor.update( {
        actor: actor,
        others: actors.filter( other => other != actor ),
        dt: dt
      } );
    } );
  }

  setInterval( () => {
    actors.forEach( actor => {
      const action = actor.spriteInfo.actions[ actor.action ];
      actor.frame = ( actor.frame + 1 ) % action.frames;
    });
  }, 100 );


</script>