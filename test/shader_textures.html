<link rel="stylesheet" href="../styles.css">
<div id="ui" style="position: absolute; right: 0"></div>
<script type="module">
  import * as THREE from 'https://unpkg.com/three/build/three.module.js';
  import Stats from 'https://unpkg.com/three/examples/jsm/libs/stats.module.js';
  
  import * as Shaders from '../lib/Shaders.js';

  const scene = new THREE.Scene();
  scene.background = new THREE.Color( 0x222255 );

  const geometry = new THREE.BoxBufferGeometry();
  
  const materials = {
    Perlin: new THREE.ShaderMaterial({
      vertexShader: Shaders.ObjectPositionOut,
      fragmentShader: `
        ${ Shaders.Noise3D }

        in vec3 v_pos;
        out vec4 outColor;

        void main() {
          float val = snoise( v_pos * 20.0 );
          outColor = vec4( val, val, val, 1.0 );
        }
      `,
      glslVersion: THREE.GLSL3,
    }),
    Clouds: new THREE.ShaderMaterial({
      vertexShader: Shaders.ObjectPositionOut,
      fragmentShader: `
        ${ Shaders.OctaveNoise }

        in vec3 v_pos;
        out vec4 outColor;

        void main() {
          float val = ( 1.0 + octaveNoise( v_pos ) ) / 2.0;
          outColor = vec4(val, val, val, 1.0);
        }
      `,
      glslVersion: THREE.GLSL3,
    }),
    Marble: new THREE.ShaderMaterial({
      uniforms: {
        scale: { value: 100.0 }
      },
      vertexShader: Shaders.ObjectPositionOut,
      fragmentShader: `
        ${ Shaders.OctaveNoise }
        uniform float scale;
        in vec3 v_pos;
        out vec4 outColor;

        void main() {
          float val = ( 1.0 + sin( octaveNoise( v_pos ) * scale ) ) / 2.0;
          outColor = vec4(val, val, val, 1.0);
        }
      `,
      glslVersion: THREE.GLSL3,
    }),
    Worley: new THREE.ShaderMaterial({
      uniforms: {
        points: { 
          value: [
            [ 0.83, 0.75 ],
            [ 0.60, 0.07 ],
            [ 0.28, 0.64 ],
            [ 0.31, 0.26 ],
          ].map( e => new THREE.Vector2( ...e ) )
        },
        u_time: { value: 0 }
      },
      vertexShader: Shaders.UVOut,
      // See: https://thebookofshaders.com/12/
      fragmentShader: `
        uniform vec2 points[4];
        uniform float u_time;

        in vec2 v_uv;
        out vec4 outColor;

        vec2 random2( vec2 p ) {
          return fract(sin(vec2(dot(p,vec2(127.1,311.7)),dot(p,vec2(269.5,183.3))))*43758.5453);
        }

        void main() {
          vec3 color = vec3(.0);

          // Scale
          vec2 st = v_uv * 3.0;

          // Tile the space
          vec2 i_st = floor(st);
          vec2 f_st = fract(st);

          float m_dist = 1.;  // minimum distance

          for (int y= -1; y <= 1; y++) {
              for (int x= -1; x <= 1; x++) {
                  // Neighbor place in the grid
                  vec2 neighbor = vec2(float(x),float(y));

                  // Random position from current + neighbor place in the grid
                  vec2 point = random2(i_st + neighbor);

                  // Animate the point
                  point = 0.5 + 0.5*sin(u_time + 6.2831*point);

                  // Vector between the pixel and the point
                  vec2 diff = neighbor + point - f_st;

                  // Distance to the point
                  float dist = length(diff);

                  // Keep the closer distance
                  m_dist = min(m_dist, dist);
              }
          }

          // Draw the min distance (distance field)
          color += m_dist;

          // Draw cell center
          color += 1.-step(.02, m_dist);

          // Draw grid
          color.r += step(.98, f_st.x) + step(.98, f_st.y);

          // Show isolines
          // color -= step(.7,abs(sin(27.0*m_dist)))*.5;

          outColor = vec4( color, 1.0 );
        }
      `,
      glslVersion: THREE.GLSL3,
    }),
    Lines: new THREE.ShaderMaterial({
      vertexShader: Shaders.ObjectPositionOut,
      fragmentShader: `
        in vec3 v_pos;
        out vec4 outColor;

        void main() {

          const vec4 grass[] = vec4[]( 
            vec4( -4.0, -5.0, 0.0, 0.1 ),
            vec4( -9.0, -10.0, -0.1, 0.0 )
          );


          float val = 0.0;

          for ( int i = 0; i < grass.length(); i ++ ) {
            vec4 blade = grass[ i ];

            float upper = blade.x * v_pos.x*v_pos.x;
            float lower = blade.y * v_pos.x*v_pos.x;
            float left  = blade.z;
            float right = blade.w;

            if ( left < v_pos.x && v_pos.x < right && lower < v_pos.y && v_pos.y < upper ) {
              val = 1.0;
            }
          }

          outColor = vec4( val, val, val, 1.0 );
        }
      `,
      glslVersion: THREE.GLSL3,
    }),
    // Grass: Green clouds with simplex-controlled direction lighter lines?
    // Wood floor: streaky tan noise with rectangles?
  };

  const mesh = new THREE.Mesh( geometry, materials.Lines );
  scene.add( mesh );

  const light = new THREE.DirectionalLight( 0xffffff );
  light.position.set( 0, 1.0, 0.5 );
  light.target.position.set( 0, 0, 0 );
  scene.add( light );

  const camera = new THREE.PerspectiveCamera( 60, window.innerWidth / window.innerHeight, 0.1, 1000 );
  camera.position.set( 0, 0, 2 );
  camera.lookAt( 0, 0, 0 );

  const renderer = new THREE.WebGLRenderer();
  document.body.appendChild( renderer.domElement );

  const stats = new Stats();
  document.body.appendChild( stats.dom );

  window.onresize = () => {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();

    renderer.setSize( window.innerWidth, window.innerHeight );
  }
  window.onresize();

  const ui = document.getElementById( 'ui' );
  for (let mat in materials) {
    const button = document.createElement( 'button' );
    button.innerText = mat;
    button.onclick = () => mesh.material = materials[ mat ];
    ui.appendChild( button );
  }
  
  requestAnimationFrame( animate );

  function animate( time ) {
    requestAnimationFrame( animate );

    materials.Worley.uniforms.u_time.value = time / 1000;

    // mesh.rotation.x += 0.005;
    // mesh.rotation.y += 0.005;

    renderer.render( scene, camera );
    stats.update();
  }

</script>