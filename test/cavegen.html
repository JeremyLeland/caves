<!DOCTYPE HTML>
<html>
  <head>
    <title>Generate Cave</title>
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type">
    <link rel="stylesheet" href="../styles.css">
  </head>
  <body>
    <canvas id="canvas" width="1280px" height="1280px" style="float: left"></canvas>
    
    <script type="module">
      import { TileMap } from '../src/TileMap.js';

      class Room {
        constructor(x, y) {
          this.x = x;
          this.y = y;
          this.halls = [];
        }
      }

      class Hall {
        constructor(startRoom, endRoom) {
          this.startRoom = startRoom;
          this.endRoom = endRoom;

          this.startRoom.halls.push(this);
          this.endRoom.halls.push(this);
        }
      }

      const SIZE = 18;
      const rooms = Array(10).fill().map(x => Array(10).fill());

      for (var row = 0; row < rooms.length; row ++) {
        for (var col = 0; col < rooms[row].length; col ++) {
          rooms[row][col] = new Room(col * SIZE + SIZE / 2, row * SIZE + SIZE / 2);
        }
      }

      const halls = [];

      addHalls(0, 0, null);

      const testCanvas = document.createElement('canvas');
      testCanvas.width = SIZE * rooms[0].length;
      testCanvas.height = SIZE * rooms.length;
      const testCtx = testCanvas.getContext('2d');

      drawRoomsAndHalls(testCtx);

      const json = {
        tiles: [
          { src: '../images/terrain/dirt.png',  color: 'brown' },
          { src: '../images/terrain/path.png',  color: 'yellow' },
          { src: '../images/terrain/empty.png', color: 'white' },
          { src: '../images/terrain/grass.png', color: 'green' },
          { src: '../images/terrain/sand.png',  color: 'white' }
        ],
        cols: testCanvas.width,
        rows: testCanvas.height,
        map: Array(testCanvas.height+1).fill().map(x => Array(testCanvas.width+1).fill(2))
      };

      const tileMap = new TileMap(json);
      tileMap.ready.then(() => {
        tileMap.setTileFromContext2D(testCtx, 0);

        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        ctx.clearRect(0, 0, canvas.width, canvas.height);
        tileMap.draw(ctx);
      });

      function addHalls(col, row, lastRoom) {
        if (col < 0 || row < 0 || col >= rooms[0].length || row >= rooms.length) {
          return;
        }

        const room = rooms[row][col];

        if (room.halls.length > 0) {
          return;
        }

        if (lastRoom != null) {
          halls.push(new Hall(lastRoom, room));
        }

        const dirs = [ [ -1, 0], [0, -1], [1, 0], [0, 1] ];

        while (dirs.length > 0) {
          const ndx = Math.floor(Math.random() * dirs.length);
          const dir = dirs.splice(ndx, 1)[0];        
          addHalls(col + dir[0], row + dir[1], room);
        }
      }

      function drawRoomsAndHalls(ctx) {
        ctx.fillStyle = 'white';
      
        for (var row = 0; row < rooms.length; row ++) {
          for (var col = 0; col < rooms[row].length; col ++) {
            const room = rooms[row][col];

            ctx.beginPath();
            ctx.arc(room.x, room.y, SIZE / 3, 0, Math.PI * 2);
            ctx.fill();
          }
        }

        ctx.strokeStyle = 'white';
        ctx.lineWidth = 2;
        halls.forEach(hall => {
          ctx.beginPath();
          ctx.moveTo(hall.startRoom.x, hall.startRoom.y);
          ctx.lineTo(hall.endRoom.x, hall.endRoom.y);
          ctx.stroke();
        });
      }
      
      
    </script>
  </body>
</html>
