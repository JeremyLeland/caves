<link rel="stylesheet" href="../styles.css">
<canvas id="canvas" style="float:left"></canvas>
<div id="ui">
  Water: <input id="waterSlider" type="range" min="0" max="1" step="0.01" value="0.43"><br>
  Beach: <input id="beachSlider" type="range" min="0" max="1" step="0.01" value="0.47"><br>
  Grass: <input id="grassSlider" type="range" min="0" max="1" step="0.01" value="0.58"><br>
  Mount: <input id="mountSlider" type="range" min="0" max="1" step="0.01" value="0.68"><br>
  <input id="regenerate" type="button" value="Regenerate">
</div>

<script type="module">
  import * as Perlin from '../src/perlin.js';

  const COLS = 500, ROWS = 500, SIZE = 1;
  const canvas = document.getElementById('canvas');
  canvas.width = COLS;
  canvas.height = ROWS;
  const ctx = canvas.getContext('2d');

  let heights;

  const terrainVals = {
    water: { value: 0.43, color: 0xffff3333 },
    beach: { value: 0.47, color: 0xff55ffff },
    grass: { value: 0.58, color: 0xff00aa00 },
    mount: { value: 0.68, color: 0xff0055aa },
    snow:  { value: 1.00, color: 0xffffffff }
  };

  // const uiDiv = document.getElementById('ui');
  // terrainVals.forEach(terrain => {
  //   const ui = document.createElement('input');
  //   ui.type = 'range';
  //   ui.min = 0;
  //   ui.max = 1;
  //   ui.step = 0.01;
  //   ui.value = terrain.value;
  //   uiDiv.appendChild(ui);

  //   //ui.onchange = regenerate();
    
  //   terrain.ui = ui;
  // });

  document.getElementById('regenerate').onclick = regenerate;
  regenerate();

  function regenerate() {
    heights = generateHeights({cols: COLS, rows: ROWS});
    drawColors(ctx, heights, getColor);
  }

  function generateHeights({cols, rows, seed = Date.now()}) {
    const heights = Array.from(Array(COLS), () => Array.from(Array(ROWS).fill(0)));

    for (var row = 0; row < rows; row ++) {
      for (var col = 0; col < cols; col ++) {
        var amplitude = 0.5;

        for (let i = 1; i <= 5; i++) {
          heights[col][row] += amplitude * Perlin.noise2(seed + col * Math.pow(2,i) / 200, seed + row * Math.pow(2,i) / 200);
          amplitude *= 0.5;
        }
      }
    }

    return heights;
  }

  // TODO: Grayscale of value mode, color mode
  // TODO: create UI from array of names and default values?
  // TODO: use canvas data instead of a bunch of fill rects

  

  function drawColors(ctx, heights, colorFunc) {
    console.time("pixelBuffer");
    const imageData = ctx.getImageData(0, 0, heights.length, heights[0].length);
    const pixelBuffer = new Uint32Array(imageData.data.buffer);

    let index = 0;
    for (var row = 0; row < ROWS; row ++) {
      for (var col = 0; col < COLS; col ++) {
        pixelBuffer[index++] = colorFunc(heights[col][row]);
      }
    }

    ctx.putImageData(imageData, 0, 0);
    console.timeEnd("pixelBuffer");
  }

  function getHeight(val) {
    const v = Math.floor(val * 255);
    return 255 << 24 | v << 16 | v << 8 | v;
  }

  function getColor(val) {
    if      (val < terrainVals['water'].value)  return terrainVals['water'].color;
    else if (val < terrainVals['beach'].value)  return terrainVals['beach'].color;
    else if (val < terrainVals['grass'].value)  return terrainVals['grass'].color;
    else if (val < terrainVals['mount'].value)  return terrainVals['mount'].color;
    else                                        return terrainVals['snow'].color;
  }

</script>
