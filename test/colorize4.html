<style>
</style>

<canvas id="canvas" style="float: left"></canvas>
<input id="picker" style="float: left" type="color" value="#00ff00">

<script type="module">
  
  const image = new Image();
  image.src = '../images/sprites/human/male/body.png';
  await image.decode();

  const canvas = document.getElementById('canvas');
  canvas.width = image.width;
  canvas.height = image.height;
  const ctx = canvas.getContext('2d');

  const picker = document.getElementById('picker');
  picker.oninput = updateColor;
  updateColor();

  function updateColor() {
    const [r, g, b] = hexToRgb(picker.value);
    const [h, s, l] = rgb2hsl(r / 255, g / 255, b / 255);

    ctx.clearRect(0, 0, image.width, image.height);
    
    ctx.save();

    ctx.drawImage(image, 0, 0);

    //ctx.filter = `brightness(${l})`;
    ctx.globalCompositeOperation = 'source-in';
    ctx.fillStyle = picker.value;
    ctx.fillRect(0, 0, image.width, image.height);

    
    ctx.globalCompositeOperation = 'luminosity';
    ctx.drawImage(image, 0, 0);

    ctx.restore();
  }

  function hexToRgb(hex) {
    return [ hex.slice(1,3), hex.slice(3,5), hex.slice(5,7) ].map(e => parseInt(e, 16));
  }

  function rgb2hsl(r,g,b) {
    // in: r,g,b in [0,1], out: h in [0,360) and s,l in [0,1]
    let v=Math.max(r,g,b), c=v-Math.min(r,g,b), f=(1-Math.abs(v+v-c-1)); 
    let h= c && ((v==r) ? (g-b)/c : ((v==g) ? 2+(b-r)/c : 4+(r-g)/c)); 
    return [60*(h<0?h+6:h), f ? c/f : 0, (v+v-c)/2];
  }

</script>

<script>
  // Luminance coefficients.
  const lumR = 0.2126;
  const lumG = 0.7152;
  const lumB = 0.0722;

  const R = 3.0;
  const G = 1.0;
  const B = 0.0;

  document.write(`<svg xmlns="
    http://www.w3.org/2000/svg">
  <filter id="color">
    <feColorMatrix 
      type="matrix" 
      values="${lumR * R} ${lumG * R} ${lumB * R} 0 0
              ${lumR * G} ${lumG * G} ${lumB * G} 0 0
              ${lumR * B} ${lumG * B} ${lumB * B} 0 0
              0 0 0 1 0">
    </feColorMatrix>
  </filter>
</svg>`);
</script>