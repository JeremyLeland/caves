<link rel="stylesheet" href="grid.css">

<style>
  div {
    position: absolute;
    overflow: hidden;
    /* background-attachment: local; */
  }

  img {
    position: absolute;
  }

  .layers {
    /* width: inherit;
    height: inherit; */
    overflow: visible;
  }

  .humanoid {
    width:  calc( 2 * 32px );
    height: calc( 2 * 32px );
    margin-left: -32px;
    margin-top:  -60px;
  }

</style>

<div id="enemy"  class="humanoid"  style="transform: translate( 192px, 128px )">
  <div class="layers">
    <img src="../images/sprites/humanoid/male/shadow.png">
    <img src="../images/sprites/humanoid/male/skeleton.png">
  </div>
</div>

<script>

  const WIDTH = 64, HEIGHT = 64;

  const Direction = { North: 0, West: 1, South: 2, East: 3 };

  const actions = {
    idle:   { col: 0, row:  0 },
    cast:   { col: 1, row:  0, frames:  6, duration: 0.6 },
    thrust: { col: 1, row:  4, frames:  7, duration: 0.7 },
    walk:   { col: 1, row:  8, frames:  8, duration: 0.8, loop: true },
    slash:  { col: 1, row: 12, frames:  5, duration: 0.5 },
    shoot:  { col: 1, row: 16, frames: 12, duration: 1.2 },
    die:    { col: 1, row: 20, frames:  5, duration: 0.4, final: true },
  }

  class Actor {
    x = 0;
    y = 0;
    angle = 0;

    #div;
    #layersDiv;
    #animation;

    constructor() {
      this.#div = document.createElement( 'div' );
      this.#div.className = 'humanoid';

      this.#layersDiv = document.createElement( 'div' );
      this.#layersDiv.className = 'layers';

      [ 'shadow', 'body', 'shoes', 'pants', 'chest', 'belt', 'hair', 'hat' ].forEach( layer => {
        const img = document.createElement( 'img' );
        img.src = `../images/sprites/humanoid/male/${ layer }.png`;
        this.#layersDiv.appendChild( img );
      } );

      this.#div.appendChild( this.#layersDiv );
      document.body.appendChild( this.#div );
    }

    update() {
      const x = Math.floor( this.x );
      const y = Math.floor( this.y );
      this.#div.style.transform = `translate( ${ this.x }px, ${ this.y }px )`;

      this.#div.scrollTop = directionFromAngle( this.angle ) * HEIGHT;
    }

    startAction( action ) {
      this.#animation?.cancel();

      this.#layersDiv.style.marginTop = `${ action.row * -HEIGHT }px`;

      const steps = action.frames - 1;

      this.#animation = this.#layersDiv.animate( {
        marginLeft: [
          `${ -WIDTH * action.col }px`, 
          `${ -WIDTH * ( action.col + steps ) }px` 
        ]
      }, {
        duration: action.duration * 1000,
        easing: `steps( ${ steps } )`,
        iterations: action.loop ? Infinity : 1,
        fill: action.final ? 'forwards' : 'none',
      } );
    }
  }


  function directionFromAngle( angle ) {
    if ( angle < ( -3 / 4 ) * Math.PI )   return Direction.West;
    if ( angle < ( -1 / 4 ) * Math.PI )   return Direction.North;
    if ( angle < (  1 / 4 ) * Math.PI )   return Direction.East;
    if ( angle < (  3 / 4 ) * Math.PI )   return Direction.South;

    return Direction.West;
  }

  const player = new Actor();
  player.x = 128;
  player.y = 128;
  
  player.startAction( actions.walk );

  player.update();

  document.addEventListener( 'mousemove', e => {
    player.angle = Math.atan2( e.clientY - player.x, e.clientX - player.y );
    player.update();
  } );

</script>