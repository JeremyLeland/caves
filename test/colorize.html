<!DOCTYPE HTML>
<html>
  <head>
    <title>Colorize Images</title>
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type">
    <link rel="stylesheet" href="../styles.css">
  </head>
  <body>
    <canvas id="canvas" width="480px" height="224px" style="float: left"></canvas>
    <table>
      <tr>
        <td>R:</td>
        <td><input type="range" min="0" max="255" id="redSlider"></td>
      </tr>
      <tr>
        <td>G:</td>
        <td><input type="range" min="0" max="255" id="greenSlider"></td>
      </tr>
      <tr>
        <td>B:</td>
        <td><input type="range" min="0" max="255" id="blueSlider"></td>
      </tr>
      <tr>
        <td colspan="2">
          <input type="text" id="colorText">
        </td>
      </tr>
    </table>
    <script type="module">
      import { ImageResource } from '../src/ImageResource.js';

      const canvas = document.getElementById('canvas');
      const ctx = canvas.getContext('2d');
      
      
      const redSlider = document.getElementById('redSlider');
      const greenSlider = document.getElementById('greenSlider');
      const blueSlider = document.getElementById('blueSlider');
      const colorText = document.getElementById('colorText');

      var color = 'white';
      colorText.value = color;

      redSlider.addEventListener('input', sliderMoved);
      greenSlider.addEventListener('input', sliderMoved);
      blueSlider.addEventListener('input', sliderMoved);
      colorText.addEventListener('change', textChanged);

      const TERRAIN_PATH = '../images/terrain/';
      const imageRes = new Map();
      ['dirt', 'sand', 'path', 'empty', 'grass'].forEach(e => {
        imageRes.set(e, new ImageResource(`${TERRAIN_PATH}/${e}.png`));
      });
      
      Promise.all([...imageRes.values()].map(e => e.promise)).then(textChanged);

      function sliderMoved() {
        color = `rgb(${redSlider.value},${greenSlider.value},${blueSlider.value})`;
        colorText.value = color;
        updateColor();
      }

      function textChanged() {
        color = colorText.value;
        ctx.fillStyle = color;
        const str = ctx.fillStyle;

        redSlider.value   = parseInt(str.slice(1, 3), 16);
        greenSlider.value = parseInt(str.slice(3, 5), 16);
        blueSlider.value  = parseInt(str.slice(5, 7), 16);

        updateColor();
      }

      function updateColor() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        var x = 0;
        imageRes.forEach((value) => {
          ctx.drawImage(value.getColorizedImage(color), x, 0);
          x += value.image.width;
        });
      }
      
    </script>
  </body>
</html>
