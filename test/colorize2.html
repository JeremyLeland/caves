<!DOCTYPE HTML>
<html>
  <head>
    <title>Colorize Images Like GIMP</title>
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type">
    <link rel="stylesheet" href="../styles.css">
  </head>
  <body>
    <canvas id="canvas" width="600px" height="224px" style="float: left"></canvas>
    <input id="color" type="color" value="#0000ff">
  
    <script type="module">

      import { ImageResource } from '../src/ImageResource.js';

      const grass = new ImageResource('../images/terrain/grass.png');

      grass.ready.then(() => {
        const image = grass.image;

        const canvas = document.getElementById('canvas');
        canvas.width = image.width;
        canvas.height = image.height;
        const context = canvas.getContext('2d');
        context.drawImage(image, 0, 0);

        
        // const pixelBuffer = new Uint32Array(imageData.data.buffer);

        // const counts = new Map();
        // pixelBuffer.forEach(color => counts.set(color, (counts.get(color) ?? 0) + 1));

        // const sorted = Array.from(counts.keys()).sort((a, b) => counts.get(b) - counts.get(a));
        // const mostCommon = sorted.find(color => color !== 0);

        // pixelBuffer.forEach((color, index, array) => {
        //   if (color == mostCommon) {
        //     array[index] = 0xFFFF0000;
        //   }
        // });
        // context.putImageData(imageData, 0, 0);

        

        // let [r, g, b] = hexToRgb('#ff1111');
        // let [h, s, l] = rgb2hsl(r, g, b);

        colorize(canvas, 0.5 * 360, 0.5, 0);

        // document.getElementById('color').value = intToHex(mostCommon);

        // const [r, g, b] = intToRgbArray(mostCommon);

        // const hsl = rgb2hsl(r, g, b);
        // const rgb = hsl2rgb(hsl[0], hsl[1], hsl[2])
        
      });

      function colorize(canvas, h, s, l) {
        const ctx = canvas.getContext('2d');
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const data = imageData.data;

        const LUM_RED =   0.22248840;
        const LUM_GREEN = 0.71690369;
        const LUM_BLUE =  0.06060791;

        let index = 0;
        for (let r = 0; r < canvas.height; r ++) {
          for (let c = 0; c < canvas.width; c ++) {
            let r = data[index] / 255;
            let g = data[index + 1] / 255;
            let b = data[index + 2] / 255;
            let a = data[index + 3];

            let lum = r * LUM_RED + g * LUM_GREEN + b * LUM_BLUE;

            // if (lightness > 0) {
            //   lum = lum * (1.0 - lightness);
            //   lum += 1.0 - (1.0 - lightness);
            // }
            // else if (lightness < 0) {
            //   lum = lum * (lightness + 1.0);
            // }

            //const l = lum;

            [r, g, b] = hsl2rgb(h, s, lum);

            data[index]   = r * 255;
            data[index+1] = g * 255;
            data[index+2] = b * 255;
            data[index+3] = a;

            index += 4;
          }
        }

        ctx.putImageData(imageData, 0, 0);
      }

      function intToRgb(i) { return [i, i >> 8, i >> 16].map(e => (e & 0xFF)); }

      function hexToRgb(hex) {
        return [ hex.slice(1,3), hex.slice(3,5), hex.slice(5,7) ].map(e => parseInt(e, 16));
      }

      function rgbToHex(r, g, b) {
        return `#${[r, g, b].map(e => e.toString(16).padStart(2, 0)).join('')}`;
      }

      // See: https://stackoverflow.com/questions/36721830/convert-hsl-to-rgb-and-hex/54014428#54014428
      function hsl2rgb(h,s,l) 
      {
        // input: h in [0,360] and s,v in [0,1] - output: r,g,b in [0,1]
        let a= s*Math.min(l,1-l);
        let f= (n,k=(n+h/30)%12) => l - a*Math.max(Math.min(k-3,9-k,1),-1);
        return [f(0), f(8), f(4)];
      }

      
      function rgb2hsl(r,g,b) {
        // in: r,g,b in [0,1], out: h in [0,360) and s,l in [0,1]
        let v=Math.max(r,g,b), c=v-Math.min(r,g,b), f=(1-Math.abs(v+v-c-1)); 
        let h= c && ((v==r) ? (g-b)/c : ((v==g) ? 2+(b-r)/c : 4+(r-g)/c)); 
        return [60*(h<0?h+6:h), f ? c/f : 0, (v+v-c)/2];
      }
    </script>
  </body>
</html>
