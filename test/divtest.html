<style>
  body { margin: 0; background-color: dimgray; }
  .prop { position: absolute; }
  .tree { background-image: url( ../images/trees.png ); }
  .tree1 { width: 96; height: 128; background-position: -128 -96; }

  .actor { position: absolute; }
  .goblin { 
    background-image: url( ../images/sprites/goblin/base.png );
    width: 65;
    height: 65;
  }
  .spider {
    background-image: url( ../images/sprites/spider/base.png );
    width: 64;
    height: 64;
  }
</style>
<div class="prop tree tree1" style="left: 32; top: 32; z-index: 160;"></div>
<div class="prop tree tree1" style="left: 64; top: 96; z-index: 224;"></div>

<script>

  const spriteInfos = { 
    "goblin": {
      "width": 65, "height": 65,
      "centers": {
        "south": { x: 32, y: 50 },
        "east":  { x: 22, y: 54 },
        "north": { x: 32, y: 58 },
        "west":  { x: 42, y: 54 }
      },
      "imagesPath": "../images/sprites/goblin",
      "dirIndex": { "north": 2, "west": 3, "south": 0, "east": 1 },
      "actions": {
        "idle": { "col": 6, "row": 0, "frames": 1 },
        "walk": { "col": 0, "row": 0, "frames": 7, "loop": true },
        "thrust": { "col": 7, "row":  0, "frames":  4 },
        "slash":  { "col": 11, "row": 0, "frames":  6 },
        "die": { "col": 0, "row": 4, "frames": 5 }
      }
    },
    "spider": {
      "width": 64, "height": 64,
      "center": { x: 31, y: 45 },
      "imagesPath": "../images/sprites/spider",
      "dirIndex": { "north": 0, "west": 1, "south": 2, "east": 3 },
      "actions": {
        "idle": { "col": 0, "row": 0, "frames": 1 },
        "walk": { "col": 4, "row": 0, "frames": 6, "loop": true },
        "attack": { "col": 1, "row": 0, "frames": 4 },
        "die": { "col": 0, "row": 4, "frames": 4 }
      }
    }
  };

  const actors = [
    createActor( { type: 'goblin', x: 32, y: 128 } ),
    createActor( { type: 'spider', x: 48, y: 224 } ),
  ];

  document.onmousemove = ( e ) => {
    actors.forEach( actor => {
      actor.angle = Math.atan2( e.pageY - actor.y, e.pageX - actor.x );
    });
  };

  setInterval( () => {
    actors.forEach( actor => {
      const action = actor.spriteInfo.actions[ actor.action ];
      actor.frame = ( actor.frame + 1 ) % action.frames;
      updateSprite( actor );
    });
  }, 100 );

  function createActor( { type, x, y } ) {
    const div = document.createElement( 'div' );
    div.setAttribute( 'class', `actor ${ type }` );
    div.style.zIndex = 2;
    document.body.appendChild( div );

    return {
      x: x, y: y, angle: Math.PI / 2,
      action: 'walk',
      frame: 0,
      spriteInfo: spriteInfos[ type ],
      div: div
    };
  }

  function updateSprite( actor ) {
    const spriteInfo = actor.spriteInfo;

    const dir = actor.action == 'die' ? 'south' : directionFromAngle( actor.angle );

    const action = spriteInfo.actions[ actor.action ];

    const center = spriteInfo.centers ? spriteInfo.centers[ dir ] : spriteInfo.center;
    const x = ( action.col + actor.frame ) * spriteInfo.width;

    const dirIndex = spriteInfo.dirIndex[ dir ];
    const y = ( action.row + dirIndex ) * spriteInfo.height;

    const style = actor.div.style;
    style.left = actor.x - center.x;
    style.top = actor.y - center.y;
    style.zIndex = actor.y;
    style.backgroundPosition = `-${ x } -${ y }`;
  }

  function directionFromAngle( angle ) {
    if ( angle < ( -3 / 4 ) * Math.PI )   return 'west';
    if ( angle < ( -1 / 4 ) * Math.PI )   return 'north';
    if ( angle < (  1 / 4 ) * Math.PI )   return 'east';
    if ( angle < (  3 / 4 ) * Math.PI )   return 'south';

    return 'west';
  }

</script>